<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autolector - Real-time Transcription</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container autolector">
        <div class="header-branding">
            <img src="{{ url_for('static', filename='icon.png') }}" alt="Autolector Logo" class="app-logo">
            <h1>Autolector</h1>
        </div>
        <p class="subtitle">Multimedia a Texto Sincronizado</p>

        <form id="upload-form" enctype="multipart/form-data">
            <div class="file-input-wrapper">
                <input type="file" id="mp4-file" name="file"
                    accept="video/mp4,audio/mpeg,audio/wav,audio/x-m4a,audio/mp3">
                <label for="mp4-file" class="custom-file-upload">Seleccionar Archivo</label>
            </div>
            <button type="submit" id="submit-btn">Comenzar Lectura</button>
        </form>

        <div id="loading" class="hidden">
            <div class="spinner"></div>
            <p id="loading-msg">Procesando...</p>
        </div>

        <div id="player-container" class="hidden">
            <audio id="audio-player" controls></audio>
        </div>

        <div id="karaoke-container" class="hidden">
            <div id="transcription-stream" class="karaoke-view"></div>
        </div>

        <div id="error" class="hidden">
            <h2>Error:</h2>
            <p id="error-message"></p>
        </div>
    </div>

    <script>
        let eventSource;
        const form = document.getElementById('upload-form');
        const audioPlayer = document.getElementById('audio-player');
        const streamContainer = document.getElementById('transcription-stream');
        const loadingDiv = document.getElementById('loading');
        const loadingMsg = document.getElementById('loading-msg');
        const playerContainer = document.getElementById('player-container');
        const karaokeContainer = document.getElementById('karaoke-container');
        const errorDiv = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('mp4-file');
            if (fileInput.files.length === 0) return;

            // Reset UI
            loadingDiv.classList.remove('hidden');
            playerContainer.classList.add('hidden');
            karaokeContainer.classList.add('hidden');
            errorDiv.classList.add('hidden');
            streamContainer.innerHTML = '';
            if (eventSource) eventSource.close();

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                loadingMsg.textContent = 'Subiendo y preparando...';
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const data = await response.json();

                if (!response.ok) throw new Error(data.message || 'Error en la subida');

                const taskId = data.task_id;
                startStreaming(taskId);
                checkStatus(taskId);

            } catch (err) {
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                errorMessage.textContent = err.message;
            }
        });

        function startStreaming(taskId) {
            console.log("Iniciando streaming para:", taskId);
            eventSource = new EventSource(`/stream/${taskId}`);

            eventSource.onopen = () => {
                console.log("Conexión SSE abierta para:", taskId);
            };

            eventSource.onmessage = (event) => {
                console.log("Mensaje SSE recibido:", event.data);
                const data = JSON.parse(event.data);

                if (data.status === 'connected') {
                    console.log("SSE Confirmado conectada");
                    return;
                }

                if (data.status === 'completed') {
                    console.log("Transcripción finalizada por SSE");
                    eventSource.close();
                    return;
                }

                if (data.error) {
                    showError(data.error);
                    eventSource.close();
                    return;
                }

                // Append new segment
                const span = document.createElement('span');
                span.className = 'segment';
                span.dataset.start = data.start;
                span.dataset.end = data.end;
                span.textContent = data.text + ' ';
                streamContainer.appendChild(span);

                // Show karaoke view if hidden
                karaokeContainer.classList.remove('hidden');
            };

            eventSource.onerror = (err) => {
                console.error("SSE Error:", err);
                // eventSource.close(); // Don't close immediately, let it retry or heartbeat
            };
        }

        async function checkStatus(taskId) {
            const interval = setInterval(async () => {
                const res = await fetch(`/status/${taskId}`);
                const data = await res.json();

                if (data.status === 'transcribing' || data.status === 'audio_extracted' || data.status === 'completed') {
                    if (audioPlayer.src === "" || !audioPlayer.src.includes(`/audio/${taskId}`)) {
                        audioPlayer.src = `/audio/${taskId}`;
                        playerContainer.classList.remove('hidden');
                        loadingDiv.classList.add('hidden');
                    }
                }

                if (data.status === 'completed' || data.status === 'error') {
                    clearInterval(interval);
                    if (data.status === 'error') showError(data.error);
                }
            }, 2000);
        }

        function showError(msg) {
            errorDiv.classList.remove('hidden');
            errorMessage.textContent = msg;
            loadingDiv.classList.add('hidden');
        }

        // Karaoke sync logic
        audioPlayer.addEventListener('timeupdate', () => {
            const currentTime = audioPlayer.currentTime;
            const segments = document.querySelectorAll('.segment');

            segments.forEach(seg => {
                const start = parseFloat(seg.dataset.start);
                const end = parseFloat(seg.dataset.end);

                if (currentTime >= start && currentTime <= end) {
                    seg.classList.add('active');
                    // Scroll into view if needed
                    seg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    seg.classList.remove('active');
                }
            });
        });
    </script>
</body>

</html>